package org.firstinspires.ftc.teamcode.teleop;

import com.qualcomm.robotcore.eventloop.opmode.OpMode;
import com.qualcomm.robotcore.eventloop.opmode.TeleOp;
import com.qualcomm.robotcore.util.ElapsedTime;


import org.firstinspires.ftc.teamcode.subsystems.Outtake;


@TeleOp(name="TESTINGGG")
public class OuttakeTeleopTest extends OpMode {

    private Outtake outtake;
    private double currentPower = 0.0;  // current motor power (0.0 to 1.0)
    private final double CHANGE_RATE = 0.01; // how fast power changes per loop
    static final double TICK_PER_MOTOR_REV = 537.7;    // eg: GoBuilda Motor Encoder
    static final double DRIVE_GEAR_REDUCTION = 1.0;     // No External Gearing.
    static final double WHEEL_DIAMETER_INCHES = 4.0;     // For figuring circumference
    static final double TICKS_PER_INCH = (TICK_PER_MOTOR_REV * DRIVE_GEAR_REDUCTION) /
            (WHEEL_DIAMETER_INCHES * Math.PI);


    @Override
    public void init() {

        outtake = new Outtake(hardwareMap);
        lastPosition = outtake.getLauncherPosition();
        timer = new ElapsedTime();
    }

    ElapsedTime timer;
    boolean timerRunning = false;

    public void startDelay() {
        timer.reset();        // set start time
        timerRunning = true;  // now we consider it active

    }
    int lastPosition;
    double RPM = 0;
    @Override
    public void loop() {
        if (gamepad1.left_trigger == 1) {
            currentPower += CHANGE_RATE;
            telemetry.addData("Power:", currentPower);
        } else if (gamepad1.right_trigger == 1) {
            currentPower -= CHANGE_RATE;
            telemetry.addData("Power:", currentPower);
        }

        if (timer.seconds() >= 0.1) {

            int currentPosition = outtake.getLauncherPosition();
            int deltaTicks = currentPosition - lastPosition;
            double deltaTime = timer.seconds(); // time in seconds

            RPM = calculateRPM(deltaTicks, TICK_PER_MOTOR_REV, deltaTime);
            int lastPosition = outtake.getLauncherPosition();
        }

//        if (currentPower > 0.5) {
            if (gamepad1.aWasPressed()) {
                // 0.5s has passed since we started the timer
                outtake.setLaunchPower(RPM);
                outtake.setSideLaunchPower(1);
                startDelay();
            }
            if (timerRunning && timer.milliseconds() > 250) {
                outtake.setSideLaunchPower(0);
                startDelay();
            }

//            } else if (gamepad1.b) {
//                outtake.setLaunchPower(0.75);
//                outtake.setSideLaunchPower(0);
//
//            } else if (gamepad1.x) {
//                outtake.emergencyStop();
//            } else if (gamepad1.y){
//                timerRunning = false; // stop tracking


//        }
//        else {
//            outtake.setLaunchPower(currentPower);
//        }
            telemetry.update();
    }
    private double calculateRPM(int deltaTicks, double ticksPerRev, double deltaTimeSec) {
        if (ticksPerRev <= 0 || deltaTimeSec <= 0) return 0;
        double revolutions = (double) deltaTicks / ticksPerRev;
        return revolutions * (60.0 / deltaTimeSec);
    }
}
